<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Einkaufsliste Cloud</title>
  <style>
    body { font-family: sans-serif; background: #fafafa; }
    .container { width: 340px; margin: 40px auto; background: #fff; border: 1px solid #eee; border-radius: 8px; padding: 24px 20px; }
    h2 { font-size: 18px; margin-bottom: 8px; }
    .product-list, .done-list { margin-bottom: 28px; }
    .product-item { display: flex; align-items: center; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee;}
    .controls { display: flex; flex-direction: column; }
    .arrow-btn { background: #f0f0f0; border: none; padding: 4px 8px; cursor: pointer; font-size: 16px;}
    .arrow-btn:active { background: #d0d0d0; }
    .count { width: 30px; text-align: center; font-size: 16px;}
    .delete-btn { background: #f0f0f0; border: none; padding: 4px 8px; cursor: pointer; font-size: 18px; color: #b00; margin-left: 8px; border-radius: 4px;}
    .delete-btn:active { background: #e0c0c0; }
    .done-item { display: flex; align-items: center; padding: 6px 0; justify-content: space-between;}
    .done-checkbox { margin-right: 8px; }
    .add-bar { display: flex; gap: 6px; margin-bottom: 10px; }
    .add-input { flex: 1; padding: 5px 8px; border: 1px solid #ccc; border-radius: 4px; }
    .add-btn { padding: 5px 10px; border: none; border-radius: 4px; background: #5ab; color: #fff; cursor: pointer; }
    .add-btn:active { background: #348; }
    .history-list { margin: 10px 0 0 0; font-size: 14px; color: #888;}
    .history-item { display: inline-block; margin: 2px 6px 2px 0; background: #f5f5f5; padding: 2px 10px; border-radius: 10px; cursor: pointer; }
    .history-item:hover { background: #e0e0e0; }
  </style>
</head>
<body>
  <div class="container">
    <div class="product-list">
     <h2>Die Dadi Einkaufsliste</h2>
      <h2>Die Dadi Einkaufsliste</h2>
      
      <div class="add-bar">
        <input type="text" class="add-input" id="addProductInput" placeholder="Produkt hinzufügen...">
        <button class="add-btn" onclick="addProduct()">+</button>
      </div>
      <div id="productList"></div>
      <div class="history-list" id="historyList"></div>
    </div>
    <div class="done-list">
       <div class="product-list">
       <h2>Einkaufen bitte</h2>
      <div class="add-bar">
        <input type="text" class="add-input" id="addDoneInput" placeholder="Noni will habt(Dadi bekommt auch..">
        <button class="add-btn" onclick="addDone()">+</button>
      </div>
      <div id="doneList"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
    import { getFirestore, collection, addDoc, doc, deleteDoc, updateDoc, onSnapshot, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

    // --- Firebase Config ---
    const firebaseConfig = {
      apiKey: "AIzaSyBJRsMbsG3Ii2bLJ5a8ObLOsKpXZsn7s9U",
      authDomain: "fridgedadi.firebaseapp.com",
      projectId: "fridgedadi",
      storageBucket: "fridgedadi.firebasestorage.app",
      messagingSenderId: "239650536755",
      appId: "1:239650536755:web:2b4cdb11229c4ba3d65246"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const productsCol = collection(db, "products");
    const historyCol = collection(db, "history");

    let products = [];
    let history = {};

    // --- Realtime Listener ---
    onSnapshot(productsCol, snapshot => {
      products = snapshot.docs.map(docSnap => ({ id: docSnap.id, ...docSnap.data() }));
      renderList();
    });

    onSnapshot(historyCol, snapshot => {
      history = {};
      snapshot.docs.forEach(docSnap => { history[docSnap.id] = docSnap.data().count; });
      renderList();
    });

    // --- Funktionen ---
    async function addProduct() {
      const input = document.getElementById('addProductInput');
      const name = input.value.trim();
      if(!name) return;
      await addDoc(productsCol, { name: name, count: 1, done: false });
      await updateHistory(name);
      input.value = '';
    }

    async function addDone() {
      const input = document.getElementById('addDoneInput');
      const name = input.value.trim();
      if(!name) return;
      await addDoc(productsCol, { name: name, count: 0, done: false });
      await updateHistory(name);
      input.value = '';
    }

    async function setCount(id, delta) {
      const p = products.find(p=>p.id===id);
      if(!p) return;
      await updateDoc(doc(db,"products",id), { count: Math.max(0,p.count+delta) });
    }

    async function toggleDone(id) {
      const p = products.find(p=>p.id===id);
      if(!p) return;
      await updateDoc(doc(db,"products",id), { done: !p.done });
    }

    async function deleteProduct(id) { await deleteDoc(doc(db,"products",id)); }

    async function updateHistory(name){
      const hRef = doc(db,"history",name);
      const hSnap = await getDoc(hRef);
      if(hSnap.exists()){
        await updateDoc(hRef,{count: history[name]+1});
      }else{
        await setDoc(hRef,{count:1});
      }
    }

    async function addProductByName(name){
      await addDoc(productsCol,{name:name,count:1,done:false});
      await updateHistory(name);
    }

    function renderList(){
      const list = document.getElementById('productList');
      const done = document.getElementById('doneList');
      const histList = document.getElementById('historyList');
      list.innerHTML = '';
      done.innerHTML = '';

      products.forEach((prod)=>{
        if(prod.count>0){
          const item=document.createElement('div'); item.className='product-item';
          const label=document.createElement('span'); label.textContent=prod.name;

          const controls=document.createElement('div'); controls.className='controls';
          const upBtn=document.createElement('button'); upBtn.className='arrow-btn'; upBtn.innerHTML='▲'; upBtn.onclick=()=>setCount(prod.id,+1);
          const downBtn=document.createElement('button'); downBtn.className='arrow-btn'; downBtn.innerHTML='▼'; downBtn.onclick=()=>setCount(prod.id,-1);
          const count=document.createElement('span'); count.className='count'; count.textContent=prod.count;
          controls.append(upBtn,count,downBtn);

          const deleteBtn=document.createElement('button'); deleteBtn.className='delete-btn'; deleteBtn.innerHTML='−'; deleteBtn.onclick=()=>deleteProduct(prod.id);

          item.append(label,controls,deleteBtn);
          list.appendChild(item);
        }else{
          const item=document.createElement('div'); item.className='done-item';
          const left=document.createElement('div'); left.style.display='flex'; left.style.alignItems='center';

          const checkbox=document.createElement('input'); checkbox.type='checkbox'; checkbox.className='done-checkbox';
          checkbox.checked=prod.done; checkbox.onchange=()=>toggleDone(prod.id);
          const label=document.createElement('span'); label.textContent=prod.name;

          left.append(checkbox,label);

          const deleteBtn=document.createElement('button'); deleteBtn.className='delete-btn'; deleteBtn.innerHTML='−'; deleteBtn.onclick=()=>deleteProduct(prod.id);

          item.append(left,deleteBtn);
          done.appendChild(item);
        }
      });

      const hist = Object.entries(history).sort((a,b)=>b[1]-a[1]).slice(0,5)
        .filter(([name])=>!products.find(p=>p.name.toLowerCase()===name.toLowerCase() && p.count>0));
      histList.innerHTML = hist.length?'Häufig benutzt: ':'';
      hist.forEach(([name,count])=>{
        const el=document.createElement('span'); el.className='history-item'; el.textContent=`${name} (${count})`;
        el.onclick=()=>addProductByName(name);
        histList.appendChild(el);
      });
    }

    document.getElementById('addProductInput').addEventListener('keydown',e=>{if(e.key==='Enter') addProduct();});
    document.getElementById('addDoneInput').addEventListener('keydown',e=>{if(e.key==='Enter') addDone();});
  </script>
</body>
</html>
